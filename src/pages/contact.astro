---
// In: src/pages/contact.astro
import BaseLayout from '../layouts/BaseLayout.astro';

// La Site Key pubblica di Turnstile. La prendiamo dalle variabili d'ambiente.
// Assicurati di averla impostata anche per lo sviluppo locale.
const turnstileSiteKey = import.meta.env.TURNSTILE_SITE_KEY;
---
<BaseLayout title="Contact Me">
  <div class="container mx-auto px-4 py-16">
    <div class="max-w-2xl mx-auto text-center">
      <h1 class="text-4xl font-bold mb-4">Let's Get in Touch</h1>
      <p class="text-lg text-gray-600 mb-12">
        Have a project in mind or just want to say hello? Fill out the form below and I'll get back to you as soon as possible.
      </p>
    </div>

    <form id="contact-form" class="max-w-2xl mx-auto">
      <div id="form-result" class="mb-6 hidden"></div>

      <div class="grid grid-cols-1 gap-6">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" name="name" id="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>
        
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" name="email" id="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>

        <div>
          <label for="message" class="block text-sm font-medium text-gray-700">Message</label>
          <textarea name="message" id="message" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
        </div>

        <!-- Widget di Cloudflare Turnstile -->
        <div class="cf-turnstile" data-sitekey={turnstileSiteKey}></div>

        <div class="text-center">
          <button type="submit" id="submit-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors text-lg disabled:bg-gray-400">
            Send Message
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Script per Turnstile e per l'invio del form -->
  <script>
    // Includiamo lo script di Turnstile
    const script = document.createElement('script');
    script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
    script.async = true;
    script.defer = true;
    document.head.appendChild(script );

    // Gestione dell'invio del form
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const formResult = document.getElementById('form-result') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      formResult.classList.add('hidden');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          formResult.className = 'p-4 mb-6 text-green-800 bg-green-100 border border-green-200 rounded-lg';
          formResult.textContent = 'Thank you! Your message has been sent successfully.';
          form.reset();
        } else {
          throw new Error('Failed to send message. Please try again.');
        }
      } catch (error) {
        formResult.className = 'p-4 mb-6 text-red-800 bg-red-100 border border-red-200 rounded-lg';
        formResult.textContent = error.message;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
        // Resetta il widget di Turnstile dopo l'invio
        window.turnstile?.reset();
      }
    });
  </script>
</BaseLayout>
