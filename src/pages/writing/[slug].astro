---
// In: src/pages/writing/[slug].astro
export const prerender = true;

import { sanityClient } from "../../lib/sanity";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { PortableText } from "astro-portabletext";

// 1) Generiamo gli slug a build-time
export async function getStaticPaths() {
  const query = `*[_type == "post" && defined(slug.current)]{"slug": slug.current}`;
  const posts = await sanityClient.fetch(query);
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// 2) Dati del singolo post (+ excerpt e mainImage opzionale)
const singlePostQuery = `*[_type == "post" && slug.current == $slug][0]{
  title,
  body,
  publishedAt,
  "slug": slug.current,
  // excerpt testuale dai blocchi
  "excerpt": pt::text(body)[0..160],
  // se nel tuo schema hai un'immagine principale, adegua il nome campo
  mainImage{
    asset->{url, metadata{dimensions}}
  }
}`;
const post = await sanityClient.fetch(singlePostQuery, { slug });

if (!post) {
  return Astro.redirect("/404");
}

// --- SEO meta
const SITE = "https://copycodeai-bki.pages.dev";
const url = `${SITE}/writing/${post.slug}`;
const description = (post.excerpt ?? post.title ?? "Articolo").trim() + "…";
const ogImage = post?.mainImage?.asset?.url ?? undefined;

// JSON-LD Article
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.title,
  description,
  datePublished: post.publishedAt,
  dateModified: post.publishedAt,
  url,
  image: ogImage ? [ogImage] : undefined,
  publisher: {
    "@type": "Organization",
    name: "CopyCodeAI"
  }
};
---

<BaseLayout title={post.title} description={description} url={url} ogImage={ogImage}>
  <fragment slot="head">
    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>
  </fragment>

  <div class="container mx-auto px-4 py-12">
    <nav class="mb-6">
      <a href="/writing" class="text-blue-600 hover:underline">← Torna al Blog</a>
    </nav>

    <article>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">{post.title}</h1>
      <p class="text-gray-600 mb-8">
        Pubblicato il: {new Date(post.publishedAt).toLocaleDateString('it-IT')}
      </p>

      <div class="prose lg:prose-xl max-w-none">
        <PortableText value={post.body} />
      </div>
    </article>
  </div>
</BaseLayout>
