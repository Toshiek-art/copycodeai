---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { sanityClient } from '../lib/sanity';

const query = `{
  "projects": count(*[_type == "project" && defined(slug.current)]),
  "aiSolutions": count(*[_type == "aiSolution" && defined(slug.current)]),
  "posts": count(*[_type == "post" && defined(slug.current)])
}`;

type Stats = { projects: number; aiSolutions: number; posts: number };

let stats: Stats = { projects: 0, aiSolutions: 0, posts: 0 };
let statsError: unknown = null;

try {
  stats = await sanityClient.fetch<Stats>(query);
} catch (error) {
  statsError = error;
}

const email = Astro.request.headers.get('CF-Access-Authenticated-User-Email');
const statsCards = [
  {
    key: 'projects',
    label: 'Progetti',
    value: stats.projects,
    note: 'Documenti Sanity con slug definito.',
  },
  {
    key: 'aiSolutions',
    label: 'Soluzioni AI',
    value: stats.aiSolutions,
    note: 'Case study, GPT custom e visual nel CMS.',
  },
  {
    key: 'posts',
    label: 'Articoli',
    value: stats.posts,
    note: 'Post visibili in Writing.',
  },
];
const links = [
  {
    href: '/admin/studio',
    title: 'Apri Sanity Studio',
    description: 'Gestisci progetti, soluzioni AI e articoli direttamente dal CMS.',
  },
  {
    href: '/admin/_debug',
    title: 'Headers di Access',
    description: 'Verifica l\'email autenticata e il JWT restituiti da Cloudflare Access.',
  },
  {
    href: '/admin/logout',
    title: 'Esci',
    description: 'Termina la sessione Zero Trust su tutti i dispositivi.',
  },
];
---

<BaseLayout title="Admin — CopyCodeAI" noindex>
  <section class="mx-auto flex max-w-5xl flex-col gap-10 px-4 py-12">
    <header class="space-y-3">
      <p class="text-xs uppercase tracking-[0.3em] text-[var(--muted)]">CopyCodeAI · Internal</p>
      <h1 class="text-3xl font-bold text-[var(--text)] md:text-4xl">Control Center</h1>
      <p class="text-[var(--muted)]">
        {email ? `Accesso verificato per ${email}.` : 'Ambiente locale: Access è bypassato durante lo sviluppo.'}
      </p>
    </header>

    <section class="grid gap-4 md:grid-cols-3" aria-label="Content overview">
      {statsError ? (
        <div class="col-span-full rounded-lg border border-red-500/30 bg-red-500/10 p-4 text-sm text-red-500 dark:text-red-300">
          {String(statsError)}
        </div>
      ) : (
        statsCards.map((card) => (
          <article class="rounded-2xl border border-black/5 bg-[var(--surface)] p-6 shadow-sm dark:border-white/10">
            <h2 class="text-sm uppercase tracking-wide text-[var(--muted)]">{card.label}</h2>
            <p class="mt-2 text-3xl font-semibold text-[var(--text)]">{card.value}</p>
            <p class="text-xs text-[var(--muted)]">{card.note}</p>
          </article>
        ))
      )}
    </section>

    <section class="grid gap-4 md:grid-cols-3" aria-label="Quick actions">
      {links.map((link) => (
        <a
          href={link.href}
          class="group flex h-full flex-col justify-between rounded-2xl border border-black/5 bg-[var(--surface)] p-6 shadow-sm transition hover:-translate-y-1 hover:shadow-lg dark:border-white/10"
        >
          <div>
            <h2 class="text-xl font-semibold text-[var(--text)]">{link.title}</h2>
            <p class="mt-3 text-sm text-[var(--muted)]">{link.description}</p>
          </div>
          <span class="mt-6 inline-flex items-center gap-2 text-sm font-semibold text-[var(--accent)]">
            Apri
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L12 6.414V17a1 1 0 11-2 0V6.414l-4.293 4.293A1 1 0 014.293 9.293l6-6z" clip-rule="evenodd" />
            </svg>
          </span>
        </a>
      ))}
    </section>

    <section class="rounded-2xl border border-black/5 bg-[var(--surface)] p-6 text-sm text-[var(--muted)] shadow-sm dark:border-white/10">
      <h2 class="text-lg font-semibold text-[var(--text)]">Note operative</h2>
      <ul class="mt-3 list-disc space-y-2 pl-5">
        <li>Sanity Studio è ora disponibile su <code>/admin/studio</code> e resta protetto da Cloudflare Access.</li>
        <li>Usa <code>/admin/_debug</code> per confermare email e token ricevuti da Zero Trust.</li>
        <li>L\'ambiente di sviluppo locale salta Access; testa il flusso completo su una Pages Preview.</li>
      </ul>
    </section>
  </section>
</BaseLayout>
