---
export const prerender = true;

// In: src/pages/work/[slug].astro
import { sanityClient } from "../../lib/sanity";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { PortableText } from "astro-portabletext";
import { Image } from "astro:assets";

// Funzione helper per l'URL dell'immagine
function getSanityImageUrl(sanityImage: any) {
  if (!sanityImage || !sanityImage.asset) return "";
  const ref = sanityImage.asset._ref;
  const [_type, assetId, dimensions, format] = ref.split('-');
  const [width, height] = dimensions.split('x').map(Number);
  return `https://cdn.sanity.io/images/1avzsmsi/production/${assetId}-${width}x${height}.${format}`;
}

// getStaticPaths chiede a Sanity quali pagine progetto creare
export async function getStaticPaths( ) {
  const query = `*[_type == "project" && defined(slug.current)]{"slug": slug.current}`;
  const projects = await sanityClient.fetch(query);
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;

// Query per i dati del singolo progetto
const singleProjectQuery = `*[_type == "project" && slug.current == $slug][0]`;
const project = await sanityClient.fetch(singleProjectQuery, { slug });

if (!project) return Astro.redirect("/404");
---

<BaseLayout title={project.title}>
  <div class="container mx-auto px-4 py-12">
    <nav class="mb-6">
      <a href="/work" class="text-blue-600 hover:underline">‚Üê Torna ai Progetti</a>
    </nav>

    <article>
      <h1 class="text-4xl md:text-5xl font-bold mb-8">{project.title}</h1>

      {/* Immagine Desktop (Visibile solo da schermi 'md' in su) */}
      <div class="hidden md:block mb-8">
        <h2 class="text-2xl font-semibold mb-4">Anteprima Desktop</h2>
        <Image
          src={getSanityImageUrl(project.mainImage)}
          alt={`Anteprima desktop del progetto ${project.title}`}
          width={1200}
          height={800}
          class="w-full h-auto rounded-lg border"
        />
      </div>

      {/* Immagine Mobile (Visibile solo su schermi piccoli, fino a 'md') */}
      {project.mobileImage && (
        <div class="md:hidden mb-8 max-w-sm mx-auto">
          <h2 class="text-2xl font-semibold mb-4 text-center">Anteprima Mobile</h2>
          <Image
            src={getSanityImageUrl(project.mobileImage)}
            alt={`Anteprima mobile del progetto ${project.title}`}
            width={400}
            height={800}
            class="w-full h-auto rounded-lg border"
          />
        </div>
      )}

      {/* Descrizione */}
      <div class="prose lg:prose-xl max-w-none mt-12">
        <h2 class="text-2xl font-semibold mb-4">Dettagli del Progetto</h2>
        <PortableText value={project.description} />
      </div>

      {/* Link al sito demo */}
      {project.projectUrl && (
        <div class="mt-12 text-center">
          <a href={project.projectUrl} target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
            Visita il Sito Demo
          </a>
        </div>
      )}
    </article>
  </div>
</BaseLayout>
