---
export const prerender = true;

// In: src/pages/work/[slug].astro
import { sanityClient } from "../../lib/sanity";
import SiteLayout from "@core/layouts/SiteLayout.astro";
import { PortableText } from "astro-portabletext";
import { Image } from "astro:assets";

// Funzione helper per l'URL dell'immagine
function getSanityImageUrl(sanityImage: any) {
  if (!sanityImage || !sanityImage.asset) return "";
  const ref = sanityImage.asset._ref;
  const [_type, assetId, dimensions, format] = ref.split("-");
  const [width, height] = dimensions.split("x").map(Number);
  return `https://cdn.sanity.io/images/1avzsmsi/production/${assetId}-${width}x${height}.${format}`;
}

// getStaticPaths chiede a Sanity quali pagine progetto creare
export async function getStaticPaths() {
  const query = `*[_type == "project" && defined(slug.current)]{"slug": slug.current}`;
  const projects = await sanityClient.fetch(query);
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;
const SITE = "https://copycodeai-bki.pages.dev";
const fallbackDescription = "Case studies built with a mix of systemic design and persuasive copywriting.";

// Query per i dati del singolo progetto
const singleProjectQuery = `*[_type == "project" && slug.current == $slug][0]{
  title,
  subtitle,
  seoTitle,
  seoDescription,
  overview,
  summary,
  description,
  mainImage,
  mobileImage,
  ogImage,
  projectUrl,
  "excerpt": pt::text(description)[0..160],
}`;
const project = await sanityClient.fetch(singleProjectQuery, { slug });

if (!project) return Astro.redirect("/404");

const url = `${SITE}/work/${slug}`;
const metaTitle = project?.seoTitle?.trim() || project.title;
const metaDescription =
  project?.seoDescription?.trim() ||
  project?.excerpt?.trim() ||
  project?.summary?.trim() ||
  project?.overview?.trim() ||
  project?.subtitle?.trim() ||
  fallbackDescription;
const ogImageSource = project?.ogImage ?? project?.mainImage;
const ogImage = ogImageSource ? getSanityImageUrl(ogImageSource) || undefined : undefined;
---

<SiteLayout title={metaTitle} description={metaDescription} url={url} ogImage={ogImage}>
  <div class="container mx-auto px-4 py-12">
    <nav class="mb-6" data-aos="fade-right">
      <a href="/work" class="text-blue-600 hover:underline">‚Üê Back to Projects</a>
    </nav>

    <article class="space-y-10">
      <header data-aos="fade-up">
        <h1 class="text-4xl font-bold md:text-5xl">{project.title}</h1>
        {project.subtitle && (
          <p class="mt-3 max-w-2xl text-lg text-[var(--muted)]">{project.subtitle}</p>
        )}
      </header>

      <div class="hidden md:block" data-aos="fade-up" data-aos-delay="100">
        <h2 class="text-2xl font-semibold mb-4">Desktop Preview</h2>
        <Image
          src={getSanityImageUrl(project.mainImage)}
          alt={`Desktop preview of project ${project.title}`}
          width={1200}
          height={800}
          class="w-full h-auto rounded-lg border"
        />
      </div>

      {project.mobileImage && (
        <div class="md:hidden max-w-sm mx-auto" data-aos="fade-up" data-aos-delay="150">
          <h2 class="text-2xl font-semibold mb-4 text-center">Mobile Preview</h2>
          <Image
            src={getSanityImageUrl(project.mobileImage)}
            alt={`Mobile preview of project ${project.title}`}
            width={400}
            height={800}
            class="w-full h-auto rounded-lg border"
          />
        </div>
      )}

      <section class="prose max-w-none lg:prose-xl dark:prose-invert" data-aos="fade-up" data-aos-delay="200">
        <h2 class="text-2xl font-semibold mb-4">Project Details</h2>
        <PortableText value={project.description} />
      </section>

      {project.projectUrl && (
        <div class="mt-12 text-center" data-aos="zoom-in" data-aos-delay="250">
          <a
            href={project.projectUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block rounded-lg bg-blue-600 px-6 py-3 font-bold text-white transition-colors hover:bg-blue-700"
          >
            Visit the Live Demo
          </a>
        </div>
      )}
    </article>
  </div>
</SiteLayout>
