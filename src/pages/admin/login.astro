---
import BaseLayout from "../../layouts/BaseLayout.astro";

const hasAccessHeader = Astro.request.headers.get('CF-Access-Jwt-Assertion');
const hasAccessCookie = (Astro.request.headers.get('cookie') ?? '').includes('CF_Authorization=');

if (!import.meta.env.DEV && (hasAccessHeader || hasAccessCookie)) {
  return Astro.redirect('/admin');
}

const redirect = Astro.url.searchParams.get('redirect') ?? '/admin';
const normalizedRedirect = redirect.startsWith('/') ? redirect : '/admin';

const loginHref = import.meta.env.DEV
  ? normalizedRedirect
  : `/admin/access?redirect=${encodeURIComponent(normalizedRedirect)}`;
---

<BaseLayout title="Admin Login â€” CopyCodeAI">
  <section class="min-h-[60vh] max-w-md mx-auto flex flex-col items-center justify-center p-8 text-center">
    <h1 class="text-3xl font-bold mb-3">Private Area</h1>
    <p class="text-[var(--muted)] mb-8">Sign in to reach the internal tools.</p>

    <a href={loginHref}
       class="inline-flex items-center gap-2 rounded-2xl px-6 py-3 shadow hover:shadow-md transition bg-black text-white">
      Continue with Cloudflare Access
    </a>

    <p class="mt-6 text-xs text-[var(--muted)]">Single Sign-On powered by Cloudflare Access.</p>

    {import.meta.env.DEV && (
      <p class="mt-6 text-xs text-[var(--muted)]">
        Local dev mode skips Access and links directly to the admin dashboard.
      </p>
    )}
  </section>
</BaseLayout>
