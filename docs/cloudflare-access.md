# Cloudflare Zero Trust (Access)

This project expects Cloudflare Access to guard any route under `/admin/*`. The login
button on `/admin/login` calls a Pages Function at `/admin/access` that redirects the
visitor to your Zero Trust application.

## Setup steps

1. **Create an Access application** in Cloudflare Zero Trust (My Team → Access → Add an application).
   - Application type: *Self-hosted*.
   - Application domain: `copycodeai.online/admin` (or a staging domain/subdomain). Se servi anche `www.copycodeai.online`, aggiungi una seconda entry `www.copycodeai.online/admin` e riutilizza lo stesso AUD.
   - Session duration: choose what works for you.
2. After saving the application, copy the values from **Domain** and **Audience (AUD)**.
   - `Domain` has the form `https://<team>.cloudflareaccess.com`.
   - `Audience` is the UUID generated by Cloudflare.
3. Add these values as environment variables for Cloudflare Pages:

   ```bash
   wrangler pages secret put CF_ACCESS_TEAM_DOMAIN
   wrangler pages secret put CF_ACCESS_AUD
   ```

   Repeat for both Preview and Production environments (or add them from the Pages dashboard → Settings → Environment variables).

4. Configure the Access **policies** so that only the intended email addresses/Groups can log in.

5. `/admin/logout` points to the Cloudflare Access logout endpoint to terminate the session.

## Local development

- Running `npm run dev` uses Astro’s dev server, so Pages Functions (and Cloudflare Access) are not applied; `/admin` pages are reachable without authentication.
- Running `wrangler pages dev` uses the Pages runtime but still bypasses Access checks locally. If you want to test the redirect, deploy to a preview branch instead.
- To avoid accidental lockouts while testing, you can temporarily comment the redirect in `functions/_middleware.ts`, but remember to restore it before pushing.
